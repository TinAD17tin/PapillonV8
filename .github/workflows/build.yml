name: Build Applications
on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android APK'
        type: boolean
        default: true
      build_ios:
        description: 'Build iOS IPA'
        type: boolean
        default: true
      sign_android:
        description: 'Sign Android APK'
        type: boolean
        default: false
      sign_ios:
        description: 'Sign iOS IPA'
        type: boolean
        default: false
      fresh_build:
        description: 'Do a fresh build (ignore caches)'
        type: boolean
        default: false

jobs:
  clean:
    runs-on: ubuntu-latest
    if: ${{ inputs.build_android || inputs.build_ios }}
    steps:
      - name: ðŸ§¹ â€¢ Clean Environment
        run: |
          if [ "${{ inputs.fresh_build }}" == "true" ]; then
            echo "Fresh build requested. Cleaning all caches."
            rm -rf node_modules
            rm -rf ~/.npm
            rm -rf ~/Library/Developer/Xcode/DerivedData || true
            rm -rf $HOME/.gradle/caches/
          fi

  # ===== ANDROID BUILD =====
  build_android:
    needs: clean
    runs-on: ubuntu-latest
    if: ${{ inputs.build_android }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¦ â€¢ Restore npm Cache
        if: ${{ inputs.fresh_build == false }}
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: ðŸ“¦ â€¢ Restore Gradle Cache
        if: ${{ inputs.fresh_build == false }}
        id: gradle-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-v1

      - name: ðŸ“€ â€¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: â˜• â€¢ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ—‚ï¸ â€¢ Install Node Dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ”¨ â€¢ Prebuild Android
        run: npx expo prebuild -p android --clean

      - name: ðŸ“ â€¢ Configure Gradle Memory
        run: |
          echo "org.gradle.jvmargs=-Xmx8g -Dorg.gradle.daemon=true" >> android/gradle.properties

      - name: ðŸ—ï¸ â€¢ Build Android
        run: |
          cd android
          ./gradlew assembleRelease
          cp app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/Papillon.apk

      - name: ðŸŒ â€¢ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/Papillon.apk
          if-no-files-found: error

      - name: ðŸ“¦ â€¢ Save npm Cache
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: ðŸ“¦ â€¢ Save Gradle Cache
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-v1

  # ===== ANDROID SIGNING =====
  sign_android:
    needs: build_android
    runs-on: ubuntu-latest
    if: ${{ inputs.sign_android && inputs.build_android }}
    steps:
      ... # (inchangÃ©)

  # ===== iOS BUILD =====
  build_ios:
    needs: clean
    runs-on: macos-latest
    if: ${{ inputs.build_ios }}
    steps:
      ... # (inchangÃ©)

  # ===== iOS SIGNING =====
  sign_ios:
    needs: build_ios
    runs-on: macos-latest
    if: ${{ inputs.sign_ios && inputs.build_ios }}
    steps:
      ... # (inchangÃ©)

  # ===== SUMMARY =====
  summary:
    needs: [build_android, build_ios, sign_android, sign_ios]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“‹ â€¢ Build Summary
        run: |
          APP_VERSION=$(node -p "require('./package.json').version")
          COMMIT_ID=$(git rev-parse --short HEAD)

          echo "## Build Summary ðŸ“±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“™ **App Version**: $APP_VERSION ($COMMIT_ID)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.fresh_build }}" == "true" ]; then
            echo "ðŸ†• Fresh build: cache ignored and recreated." >> $GITHUB_STEP_SUMMARY
          else
            if [ "${{ steps.npm-cache.outputs.cache-hit }}" == 'true' ]; then
              echo "ðŸ“¦ npm cache: âœ… Hit" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“¦ npm cache: âŒ Miss" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.gradle-cache.outputs.cache-hit }}" == 'true' ]; then
              echo "ðŸ“¦ Gradle cache: âœ… Hit" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“¦ Gradle cache: âŒ Miss" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Android APK**:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_android }}" == "true" ]; then
            if [ "${{ needs.build_android.result }}" == "success" ]; then
              echo "   - ðŸ“¦ Unsigned APK: âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "   - ðŸ“¦ Unsigned APK: âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ inputs.sign_android }}" == "true" ]; then
              if [ "${{ needs.sign_android.result }}" == "success" ]; then
                echo "   - âœï¸ Signed APK: âœ… Success" >> $GITHUB_STEP_SUMMARY
              else
                echo "   - âœï¸ Signed APK: âŒ Failed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "   - âœï¸ Signed APK: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "   - ðŸ“¦ Unsigned APK: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "   - âœï¸ Signed APK: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ **iOS IPA**:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_ios }}" == "true" ]; then
            if [ "${{ needs.build_ios.result }}" == "success" ]; then
              echo "   - ðŸ“¦ Unsigned IPA: âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "   - ðŸ“¦ Unsigned IPA: âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ inputs.sign_ios }}" == "true" ]; then
              if [ "${{ needs.sign_ios.result }}" == "success" ]; then
                echo "   - âœï¸ Signed IPA: âœ… Success" >> $GITHUB_STEP_SUMMARY
              else
                echo "   - âœï¸ Signed IPA: âŒ Failed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "   - âœï¸ Signed IPA: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "   - ðŸ“¦ Unsigned IPA: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "   - âœï¸ Signed IPA: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          fi